#!/bin/bash
#
# Create the darwin bundle
#
set -e
assert_subshell() {
    # Subshells are strange with set -e so need to return $? after called to
    # test false at outershell.
    return $?
}

umask 027

if [[ $debug ]]; then
    set -x
fi

bundle_err() {
    echo "$1" 1>&2
    exit 1
}

if ! [[ $repo && $dest && $dmg_src ]]; then
    bundle_err "Usage: repo=<url> dest=<dir> dmg_src=<dir> $0"
fi
export bundle_repo=$repo

# First channel is always develop
export bundle_channel=develop

export bundle_name=org.radtrack
export bundle_os_machine=darwin/x86_64
export bundle_support=support@radtrack.org
export bundle_version=$(date +%Y%m%d.%H%M%S)

src=$PWD

if [[ $dev_install ]]; then
    mkdir -p "$dest"
    _install() {
        for f in "$@"; do
            if [[ ! -r $f ]]; then
                bundle_err "$f: not found"
            fi
            ln -s "$PWD/$f" "$dest"
        done
    }
    _install_rm() {
        _install "$@"
    }
else
    if [[ ! -d $dest ]]; then
        bundle_err "$dest: destination directory doesn't exist"
    fi
    _install() {
        install -m 0440 "$@" "$dest"
    }
    _install_rm() {
        _install "$@"
        rm "$@"
    }
fi

dest_bundle_root=$dest/$bundle_name
dest=$dest_bundle_root/$bundle_os_machine/$bundle_version
mkdir -p "$dest"
dest=$(cd "$dest"; pwd)

cp -a ../../../radiasoft/fedora-container/libexec/find-available-ip.pl .
tgz=install.tar.gz
tar cz -T - -f "$tgz" <<'EOF'
darwin-radtrack.sh
find-available-ip.pl
install-darwin-pkg.sh
install-functions.sh
install-lock.sh
install-update-daemon.sh
install-user.sh
remove-existing-vm.pl
update-daemon.sh
EOF
_install_rm "$tgz"

channel_dir=$(dirname "$dest")/$bundle_channel
channel_new=$channel_dir.new
channel_old=$channel_dir.old

for dmg in XQuartz VirtualBox Vagrant; do
    f=$dmg_src/$dmg.dmg
    _install "$f"
done

_install install-main.sh

(
    cd ..
    if [[ ! $no_container_build ]]; then
        debug="$debug" container-conf/builder vagrant
    fi
    pwd
    _install_rm vagrant-build/radiasoft-radtrack.box
)
assert_subshell

for b in install.sh update.sh; do
    n=$dest/$b
    perl -w -p - "$b" <<'EOF' > "$n"
use strict;
s{BUNDLE_NAME}{$ENV{bundle_name}}g;
s{CHANNEL}{$ENV{bundle_channel}}g;
s{OS_MACHINE}{$ENV{bundle_os_machine}}g;
s{REPO}{$ENV{bundle_repo}}g;
s{SUPPORT}{$ENV{bundle_support}}g;
s{VERSION}{$ENV{bundle_version}}g;
EOF
    chmod 440 "$n"
done

(
    cd "$dest"
    f="$src/MANIFEST"
    ls > "$f"
    _install_rm "$f"
)
assert_subshell

rm -rf "$channel_new" "$channel_old"
mkdir "$channel_new"
(
    cd "$channel_new"
    ln -s ../"$bundle_version"/{install,update}.sh .
)
assert_subshell

if [[ -d $channel_dir ]]; then
    mv "$channel_dir" "$channel_old"
fi
mv "$channel_new" "$channel_dir"

if [[ ! $dev_install ]]; then
    chgrp -R -P -h apache "$dest_bundle_root"
fi

echo "Created: $dest"
